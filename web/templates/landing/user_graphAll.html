{% load static %}
{% include "header.html" %}
{% include 'menutemp.html' %}

<div class="flex-grow-1 container-p-y"
     xmlns="http://www.w3.org/1999/html"
     style="background-color:#F6F6F6 !important;
            padding-right:9.625rem;
            margin-top: 1.625rem;
            padding-left:9.625rem">
    <!--    row1-->

          <!-- inline calendar (flatpicker) -->
    <div style="--bs-gutter-x: 2.625rem;">
        <div class="row" style="display: flex">
            <select id="myDropdown" style="display: inline-flex;padding: 16px 17px;align-items: center;gap: 66px; border-radius: 6px;background: var(--0-b, #FFF);width: 13%" onchange="logSelectedOption(false)" onload="logSelectedOption(true)">
            </select>
            <div class="col app-calendar-sidebar" id="app-calendar-sidebar">
                <div class="datepicker-container">
                    <input type="text" id="datepickerToggle"  style="display: inline-flex;height: 56px;padding: 16px 22px;align-items: flex-end;gap: 17px;flex-shrink: 0;border-radius: 6px;background: var(--0-b, #FFF);" placeholder="Select a date range" readonly>
                    <div class="datepicker-box " id="datepickerBox">
                        <div class="event-sidebar" id="addEventSidebar"></div>
                        <div class="datepicker-footer" >
                            <button id="applyButton">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedRange = [];
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 6);

            // Ensure the element is available before initializing
            const addEventSidebar = document.getElementById("addEventSidebar");
            if (addEventSidebar) {
                // Initialize the flatpickr datepicker with range mode
                const datepicker = flatpickr(addEventSidebar, {
                    inline: true,
                    showMonths: 1, // Show two monshowMonths: 2, // Show two mon
                    mode: "range",
                    defaultDate: [sevenDaysAgo, today],
                    onChange: function(selectedDates, dateStr, instance) {
                        selectedRange = selectedDates;
                    }
                });
                selectedRange = [sevenDaysAgo, today];
            } else {
                console.error("Element with ID 'addEventSidebar' not found.");
            }

            // Get the elements
            const datepickerToggle = document.getElementById('datepickerToggle');
            const datepickerBox = document.getElementById('datepickerBox');
            const applyButton = document.getElementById('applyButton');
            datepickerToggle.value = `${sevenDaysAgo.toLocaleDateString()} - ${today.toLocaleDateString()}`;

            // Function to toggle the datepicker visibility
            function toggleDatepicker() {
                if (datepickerBox.style.display === "none" || datepickerBox.style.display === "") {
                    datepickerBox.style.display = "block";
                } else {
                    datepickerBox.style.display = "none";
                }
            }

            // Add click event listener to the toggle input box
            datepickerToggle.addEventListener('click', toggleDatepicker);

            // Hide the datepicker if clicked outside of it
            document.addEventListener('click', function(event) {
                if (!datepickerBox.contains(event.target) && event.target !== datepickerToggle) {
                    datepickerBox.style.display = "none";
                }
            });

            // Apply button event listener
            applyButton.addEventListener('click', function() {
                if (selectedRange.length === 2) {
                    const startDate = selectedRange[0].toLocaleDateString();
                    const endDate = selectedRange[1].toLocaleDateString();
                    datepickerToggle.value = `${startDate} - ${endDate}`;
                } else {
                    alert("Please select a date range.");
                }
                toggleDatepicker(); // Hide the datepicker after applying the date range
            });
        });
    </script>

    <div id="selectedOptionDisplay" style="margin-top: 10px;">
            <!-- 선택된 옵션이 여기에 표시됩니다 -->
        </div>

        <script>
            let conIdSenidMap = {};
            let uniqueGtrSenName = [];
            function logSelectedOption(init) {
                const dropdown = document.getElementById('myDropdown');

                const selectedIndex = dropdown.selectedIndex;
                const selectedOption = dropdown.options[selectedIndex].value;
                const displayDiv = document.getElementById('selectedOptionDisplay');
                displayDiv.innerHTML = "";
                Object.entries(conIdSenidMap).forEach(([conId, conInf]) => {
                    if(conId === selectedOption){
                        uniqueGtrSenName.forEach(uniqueSenName => {
                        let sum = 0;
                        let count = 0;
                        let value;

                        Object.entries(conInf.gtr || {}).forEach(([senid, senInf]) => {
                            if (senInf.sen_name === uniqueSenName) {
                                sum += senInf.value;
                                count++;
                                value = count > 0 ? sum / count : "-";
                            }
                        });
                        if(count !== 0){
                            let card = `${uniqueSenName}
                                <div class="col-lg-8 order-lg-2 mb-4" style="border-radius: 15px; width: 100%; min-width: 1359px !important; background: var(--Gray-0, #FFF)">
                                    <div class="card" style="box-shadow: 0 0px red; --bs-card-cap-padding-x: 1.0rem">
                                        <div class="card-header" style="justify-content: space-between; display: flex; flex-direction: row; padding-bottom:0.3rem">
                                            <div style="justify-content:flex-start; display: flex;">
                                                <div class="m-0 me-2 pb-3" style="color: var(--80-w, #595757);font-family: Pretendard;font-size: 24px;font-style: normal;font-weight: 500;line-height: normal;padding-right:1.2rem">조회한 기간의 평균 수치</div>
                                                <h5 class="m-0 me-2 pb-3" style="color: var(--40-w, #B5B6B6); font-family: Pretendard; font-size: 22px; width:201; font-style: normal; font-weight: 600; line-height: normal">${value}</h5>
                                            </div>
                                        </div>
                                        <div class="text-nowrap" style="padding-bottom: 2rem; padding-left: 2.0rem; padding-right: 1.625rem;">
                                            <!-- Additional content can be added here -->

                                        </div>
                                    </div>
                                </div>`;
                                displayDiv.innerHTML += card;

                        }
                    })
                    }
                });
            }
           document.addEventListener('DOMContentLoaded', function() {
                // Fetch data from the server endpoint
                fetch('/api/util/user-table-data/') // replace with your actual endpoint URL
                    .then(response => response.json())
                    .then(data => {
                        const dropdown = document.getElementById('myDropdown');
                        conIdSenidMap = data.con_id_senid_map;
                        uniqueGtrSenName = data.unique_gtr_sen_name;

                        const sortedEntries = Object.entries(conIdSenidMap).sort(([conId1], [conId2]) => conId1 - conId2);

                        sortedEntries.forEach(([conId, conInf]) =>{
                            const option = document.createElement('option');
                            option.value = conId; // Adjust based on your actual data structure
                            option.textContent = conInf.con_name; // Adjust based on your actual data structure
                            dropdown.appendChild(option);
                        });
                        const initialSelectedIndex = 0; // Set to the desired index
                        dropdown.selectedIndex = initialSelectedIndex;
                        logSelectedOption(true);
                    })
                    .catch(error => console.error('Error fetching data:', error));
            });
        </script>
        <!-- 재배동 실시간 현황 -->
<div id="chart-container"></div>

          <script src="https://d3js.org/d3.v7.min.js"></script>

        <script>
            const margin = { top: 70, right: 30, bottom: 40, left: 80 };
            const width = 1200 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            // Set up the x and y scales

            const x = d3.scaleTime()
              .range([0, width]);

            const y = d3.scaleLinear()
              .range([height, 0]);

            // Create the SVG element and append it to the chart container

            const svg = d3.select("#chart-container")
              .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create a fake dataset

            const dataset = [
              { date: new Date("2022-01-01"), value: 200 },
              { date: new Date("2022-02-01"), value: 250 },
              { date: new Date("2022-03-01"), value: 180 },
              { date: new Date("2022-04-01"), value: 300 },
              { date: new Date("2022-05-01"), value: 280 },
              { date: new Date("2022-06-01"), value: 220 },
              { date: new Date("2022-07-01"), value: 300 },
              { date: new Date("2022-08-01"), value: 450 },
              { date: new Date("2022-09-01"), value: 280 },
              { date: new Date("2022-10-01"), value: 600 },
              { date: new Date("2022-11-01"), value: 780 },
              { date: new Date("2022-12-01"), value: 320 }
            ];

            // Define the x and y domains

            x.domain(d3.extent(dataset, d => d.date));
            y.domain([0, d3.max(dataset, d => d.value)]);

            // Add the x-axis

            svg.append("g")
              .attr("transform", `translate(0,${height})`)
              .call(d3.axisBottom(x)
                .ticks(d3.timeMonth.every(1))
                .tickFormat(d3.timeFormat("%b %Y")));


            // Add the y-axis

            svg.append("g")
              .call(d3.axisLeft(y))

            // Create the line generator

            const line = d3.line()
              .x(d => x(d.date))
              .y(d => y(d.value));

            // Add the line path to the SVG element

            svg.append("path")
              .datum(dataset)
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-width", 1)
              .attr("d", line);

        </script>
    </div>
<!-- Footer -->
<footer class="content-footer footer bg-footer-theme">
    <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
        <div class="mb-2 mb-md-0">
            ©
            <script>document.write(new Date().getFullYear());</script>
            , made with ❤️ by
            <a href="https://themeselection.com"
               target="_blank"
               class="footer-link fw-medium">ThemeSelection</a>
        </div>
        <div class="d-none d-lg-inline-block">
            <a href="https://themeselection.com/license/"
               class="footer-link me-4"
               target="_blank">License</a>
            <a href="https://themeselection.com/"
               target="_blank"
               class="footer-link me-4">More Themes</a>
            <a href="https://demos.themeselection.com/sneat-bootstrap-html-admin-template/documentation/"
               target="_blank"
               class="footer-link me-4">Documentation</a>
            <a href="https://themeselection.com/support/"
               target="_blank"
               class="footer-link d-none d-sm-inline-block">Support</a>
        </div>
    </div>
</footer>
<!-- / Footer -->
<div class="content-backdrop fade"></div>
<!--/ Content wrapper -->
{% include 'footer.html' %}
